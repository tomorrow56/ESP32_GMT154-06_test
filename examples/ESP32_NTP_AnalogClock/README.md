# ESP32 NTPアナログ時計 with Web設定 & OTA

> **本プロジェクトは [ESP32_GMT154-06_test](https://github.com/tomorrow56/ESP32_GMT154-06_test) リポジトリの `examples` ディレクトリ配下に追加されています。**

このプロジェクトは、ESP32とLovyanGFXライブラリを使い、NTPサーバーから取得した時刻をアナログ時計としてLCDに表示するサンプルです。以下の特徴があります：

- **Web UI設定機能**: ブラウザからWiFiのSSIDとパスワードを設定可能
- **OTA更新機能**: WiFi経由でプログラムを更新可能
- **タッチセンサー制御**: IO39ピンのタッチセンサーで設定モードに切り替え可能

## ハードウェア要件
- ESP32開発ボード
- 240x240 LCDパネル（ST7789ドライバ搭載推奨）
- 配線用ジャンパワイヤ
- IO39ピンに接続するタッチセンサーまたは対象物（金属板や対象物でも可）

### LCDピン接続例
| LCDピン | ESP32ピン |
|---------|-----------|
| RESET   | IO4       |
| D/C     | IO2       |
| DATA    | IO23      |
| CLK     | IO18      |
| BL      | IO25      |

## ソフトウェア要件
- PlatformIO
- Arduino Framework for ESP32
- LovyanGFX v1.1.9以上
- AsyncElegantOTA v2.2.7以上
- ESPAsyncWebServer-esphome v3.0.0以上
- Arduino_JSON v0.2.0以上

## プロジェクト構成

```
/src
  |- main.cpp           # メインプログラム
  |- html_content.h     # Web UI用HTMLコンテンツ
  |- wifi_manager.h     # WiFi設定管理ライブラリヘッダ
  |- wifi_manager.cpp   # WiFi設定管理ライブラリ実装
  |- ntp_clock.h        # NTP時計ライブラリヘッダ
  |- ntp_clock.cpp      # NTP時計ライブラリ実装
  |- touch_manager.h    # タッチセンサー管理ライブラリヘッダ
  |- touch_manager.cpp  # タッチセンサー管理ライブラリ実装
/platformio.ini          # PlatformIO設定ファイル
/README.md               # プロジェクト説明
```

## セットアップ手順
1. 本リポジトリをクローンまたはダウンロード
2. `platformio.ini`の内容を確認
3. PlatformIOでビルド＆書き込み
4. **初回起動時に設定モードが自動的に開始されます**
   - または、IO39ピンにタッチしながら起動することで強制的に設定モードを開始できます
5. スマートフォンで`ESP32-Clock-Setup`のWiFiに接続（パスワード: `12345678`）
6. ブラウザで`192.168.4.1`にアクセスしてWeb UIからWiFi設定を行う

## 動作概要
- **初回起動時**: WiFi設定がない場合、自動的に設定モード（APモード）を開始
- **通常動作時**: WiFiに接続し、NTPサーバーから時刻を取得してアナログ時計を表示
- **時刻同期**: 1時間ごとに自動でNTP再同期
- **設定変更**: 通常動作中にIO39ピンに３秒間タッチすると設定モードに切り替わり
- **Web管理**: 通常動作時はブラウザから設定変更やOTA更新が可能

## 注意
- IO39ピンは多くのESP32ボードでタッチセンサー入力として使用できます。タッチセンサーは金属板や対象物に触れることで反応します。
- タッチの閾値はソースコードの`TOUCH_THRESHOLD`値（83に設定）で調整可能です。必要に応じて変更してください。
- 時計の描画処理はシンプルな例です。デザインや針の形状などは自由にカスタマイズ可能です。
- WiFi設定は内部メモリに保存されるため、一度設定すれば再起動後も維持されます。
- 設定を初期化したい場合は、起動時にIO39ピンにタッチし続けることで設定モードに入れます。

## 動作モード

### 1. 設定モード（APモード）

初回起動時やIO39ピンのタッチセンサー長押し時に入るモードです：

1. ESP32が`ESP32-Clock-Setup`というWiFiアクセスポイントを作成
2. スマートフォンでこのWiFiに接続（パスワード: `12345678`）
3. ブラウザで`192.168.4.1`にアクセス
4. Web UIから以下の設定が可能：
   - WiFiのSSIDとパスワード
   - OTA更新用の認証情報
5. 設定後は「再起動」ボタンを押して通常モードに移行

### 2. 通常モード（時計表示モード）

設定完了後の通常動作モードです：

1. 設定されたWiFiに接続し、NTPから時刻を取得
2. アナログ時計をLCDに表示
3. Web管理インターフェースも利用可能：
   - ブラウザで`http://[ESP32のIPアドレス]`にアクセス
   - `/update`ページでOTA更新が可能（認証情報が必要）
   - `/setup`ページでWiFiやOTA設定の変更が可能

### PlatformIOでのOTAアップロード

シリアル接続なしでアップロードする場合は、`platformio.ini`の以下の行のコメントを外し、ESP32のIPアドレスを指定します：

```ini
upload_protocol = espota
upload_port = 192.168.1.xxx  ; ESP32のIPアドレスを指定
```

## ライセンス
MIT
