# ESP32 NTPアナログ時計 要件定義書

## 1. プロジェクト概要

ESP32マイコンを使用して、NTPサーバーと同期するアナログ時計を開発する。ユーザーはWebインターフェースを通じてWiFi設定やOTA（Over-The-Air）アップデート設定を構成できる。また、タッチセンサーを使用して設定モードに切り替えることができる。

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 時計表示
- 240x240ピクセルのLCDディスプレイにアナログ時計を表示
- 時針、分針、秒針を表示
- 時計の文字盤に時間マーカーを表示
- デジタル時間表示も同時に表示（HH:MM:SS形式）

#### 2.1.2 NTP時刻同期
- 指定されたNTPサーバー（デフォルト: ntp.nict.jp）と時刻を同期
- 日本時間（UTC+9）に対応
- 1時間ごとに自動的に再同期
- WiFi接続が切れた場合、内部時計を使用して時刻を維持

### 2.2 設定機能

#### 2.2.1 WiFi設定
- 複数のWiFiネットワーク設定を保存可能
- SSIDとパスワードをWebインターフェースから設定可能
- 設定はESP32の不揮発性メモリに保存

#### 2.2.2 OTA更新設定
- OTAアップデート用のユーザー名とパスワードを設定可能
- デフォルト設定: ユーザー名：admin / パスワード：admin
- 設定はESP32の不揮発性メモリに保存

#### 2.2.3 タッチセンサー設定
- IO32ピンをタッチセンサーとして使用
- タッチ検出閾値: 83（調整可能）
- 長押し検出時間: 3000ms（調整可能）

### 2.3 操作モード

#### 2.3.1 通常モード
- NTPサーバーと同期したアナログ時計を表示
- タッチセンサーの長押しで設定モードに切り替え
- WiFi接続状態を監視し、切断時に再接続を試行

#### 2.3.2 設定モード（APモード）
- ESP32をアクセスポイントとして動作
  - SSID: ESP32-Clock-Setup
  - パスワード: 12345678
  - IPアドレス: 192.168.4.1
- Webインターフェースを提供して設定を可能に
- タッチセンサーの長押しでデバイスを再起動

## 3. ハードウェア要件

### 3.1 必須コンポーネント
- ESP32開発ボード
- 240x240 LCDパネル（ST7789ドライバ）
- タッチセンサー（IO32ピンに接続）

### 3.2 ピン接続
- LCD接続
  - RESET: IO4
  - D/C: IO2
  - DATA: IO23
  - CLK: IO18
  - バックライト: IO25
- タッチセンサー: IO32

## 4. ソフトウェア要件

### 4.1 開発環境
- PlatformIO
- Arduino Framework for ESP32

### 4.2 必須ライブラリ
- LovyanGFX v1.1.9以上
- AsyncElegantOTA v2.2.7以上
- ESPAsyncWebServer-esphome v3.0.0以上
- Arduino_JSON v0.2.0以上

### 4.3 ソフトウェアアーキテクチャ
- モジュール化されたクラスベース設計
  - WiFiManager: WiFi接続とAP設定、OTA更新機能を管理
  - NTPClock: NTP時刻同期とアナログ時計表示機能を管理
  - TouchManager: タッチセンサー検出と長押し機能を管理
  - HTMLコンテンツ: Web UI用のHTMLを分離管理

## 5. ユーザーインターフェース要件

### 5.1 物理インターフェース
- タッチセンサー
  - 3秒間の長押しで設定モードと通常モードを切り替え
  - 設定モード中の長押しでデバイスを再起動

### 5.2 Webインターフェース
- セットアップページ
  - WiFi設定（SSID、パスワード）
  - OTA更新設定（ユーザー名、パスワード）
  - 再起動ボタン
- メインページ
  - 現在の接続情報表示
  - OTA更新へのリンク
  - 設定ページへのリンク
- 再起動ページ
  - 再起動カウントダウン表示

## 6. セキュリティ要件

### 6.1 データ保護
- WiFi認証情報は不揮発性メモリに安全に保存
- OTA更新にはユーザー名とパスワードによる認証が必要

### 6.2 アクセス制御
- 設定モードのアクセスポイントにはパスワード保護
- OTA更新プロセスには認証が必要

## 7. 拡張性と保守性

### 7.1 コード構造
- 機能ごとに分離されたクラスベースの設計
- 再利用可能なライブラリとしてモジュール化
- 明確に定義されたインターフェースによる疎結合設計

### 7.2 将来の拡張性
- タイムゾーン設定の追加
- 複数のNTPサーバー設定
- 時計表示のカスタマイズオプション
- より堅牢なエラー処理メカニズム

## 8. テスト要件

### 8.1 機能テスト
- NTP同期機能の検証
- WiFi接続と再接続機能の検証
- タッチセンサー操作の検証
- Web UI機能の検証
- OTA更新プロセスの検証

### 8.2 エッジケーステスト
- WiFi接続が利用できない場合の動作
- NTPサーバーが応答しない場合の動作
- 電源サイクル後の設定保持の確認
- 不正なタッチ入力への対応

## 9. ドキュメント要件

### 9.1 ユーザードキュメント
- セットアップガイド
- 操作マニュアル
- トラブルシューティングガイド

### 9.2 開発者ドキュメント
- アーキテクチャ概要
- クラスとメソッドの説明
- 拡張方法の説明

## 10. プロジェクト成果物

### 10.1 ソースコード
- main.cpp: メインプログラム
- html_content.h: Web UI用HTMLコンテンツ
- wifi_manager.h/cpp: WiFi設定管理ライブラリ
- ntp_clock.h/cpp: NTP時計ライブラリ
- touch_manager.h/cpp: タッチセンサー管理ライブラリ

### 10.2 ドキュメント
- README.md: プロジェクト概要と使用方法
- requirements.md: 要件定義書（本ドキュメント）

### 10.3 設定ファイル
- platformio.ini: PlatformIO設定ファイル
